# ============================================================
# ðŸ§   Custom Airflow + PaddleOCR + LangChain + PyMuPDF (ARM-ready)
# ============================================================

FROM apache/airflow:2.9.1

# ------------------------------------------------------------
# ðŸ§© Install system dependencies (root only)
# ------------------------------------------------------------
USER root
RUN apt-get update && apt-get install -y \
    wget git python3-dev libgl1-mesa-glx libglib2.0-0 libgomp1 \
    libjpeg-dev poppler-utils tesseract-ocr \
    build-essential cmake g++ && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------------
# ðŸ§  Python layer (run as airflow user)
# ------------------------------------------------------------
USER airflow
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    # âœ… 1. Install PaddlePaddle (ARM CPU mirror)
    pip install --no-cache-dir -i https://www.paddlepaddle.org.cn/packages/stable/cpu paddlepaddle==2.6.1 && \
    # âœ… 2. Install PaddleOCR from GitHub
    pip install --no-cache-dir "git+https://github.com/PaddlePaddle/PaddleOCR.git@release/2.8" && \
    # âœ… 3. Install PyMuPDF + LangChain stack + Sentence Transformers
    pip install --no-cache-dir --prefer-binary \
        PyMuPDF==1.24.10 \
        "langchain>=0.3.0" \
        "langchain-core>=0.3.0" \
        "langchain-community>=0.3.0" \
        "sentence-transformers==2.6.1" \
        "chromadb==0.5.3" \
        "tiktoken==0.7.0" && \
    # âœ… 4. Install PyTorch CPU wheels
    pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu && \
    # âœ… 5. Clean pip cache to reduce image size
    pip cache purge
